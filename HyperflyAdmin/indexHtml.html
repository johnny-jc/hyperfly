<div id="pjax-content">
    <div class="wrapper">

        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="javascript:void(0)"
                       role="button"><i class="fas fa-bars"></i></a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="javascript:void(0)" class="nav-link">首页</a>
                </li>
            </ul>

            <ul class="navbar-nav ml-auto">
                <!--
                <li class="nav-item">
                    <a class="nav-link" data-widget="navbar-search" href="javascript:void(0)" role="button">
                        <i class="fas fa-search"></i>
                    </a>
                    <div class="navbar-search-block navbar-search-open" style="display: none;">
                        <form class="form-inline">
                            <div class="input-group input-group-sm">
                                <input class="form-control form-control-navbar" type="search" placeholder="Search"
                                       aria-label="Search">
                                <div class="input-group-append">
                                    <button class="btn btn-navbar" type="submit">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <button class="btn btn-navbar" type="button" data-widget="navbar-search">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </li>
                -->

                <li class="nav-item">
                    <a class="nav-link" data-widget="fullscreen" href="javascript:void(0)" role="button">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="javascript:void(0)" role="button" title="退出" id="sign-out">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </li>
                <!--
                <li class="nav-item">
                    <div class="dropdown">
                        <button type="button" class="btn dropdown-toggle" id="dropdownMenu" data-toggle="dropdown">
                            <span class="fas fa-user"></span>
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
                            <li>
                                <span class="fas fa-sign-out-alt"></span>
                            </li>
                        </ul>
                    </div>
                </li>
                -->
            </ul>

        </nav>
        <!-- nav end -->
        <aside class="main-sidebar sidebar-dark-primary elevation-4">

            <a class="brand-link" href="javascript:void(0)">
                <span class="text-bold">HA</span>
                <span class="brand-text font-weight-light">HyperflyAdmin</span>
            </a>
            <div class="sidebar" style="overflow-y: auto">
                <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                    <div class="info">
                        <a class="d-block" href="javascript:void(0)">
                            <span id="admin-username"></span>
                            <button id="update-admin-password-btn" class="btn btn-xs btn-default">
                                <span class="fa fa-edit">修改密码</span>
                            </button>
                        </a>
                    </div>
                </div>
                <!-- user panel end -->
                <div class="form-inline">
                    <div class="input-group" data-widget="sidebar-search">
                        <input class="form-control form-control-sidebar" type="search" placeholder="Search"
                               aria-label="Search">
                        <div class="input-group-append">
                            <button class="btn btn-sidebar">
                                <i class="fas fa-fw fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="sidebar-search-results">
                        <!--
                        <div class="list-group">
                            <a href="#" class="list-group-item">
                                <div class="search-title">
                                </div>
                            </a>
                        </div>
                        -->
                    </div>
                </div>
                <!-- form-inline end -->
                <nav class="mt-2">
                    <div id="menu-container">

                    </div>
                    <!--
                    <ul class="nav nav-pills nav-sidebar flex-column menu-ul" id="default-menu" style="display: block">
                        <li class="nav-item">
                            <a href="javascript:void(0)" class="nav-link toggle-ul">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <p>
                                    权限管理
                                    <i class="right fas fa-plus-circle"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview" style="display: block">
                                <li class="nav-item menu-item" attr="./module/permission/admin.html">
                                    <a href="javascript:void(0)" class="nav-link active">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>管理员管理</p>
                                    </a>
                                </li>
                                <li class="nav-item menu-item" attr="./module/permission/permission.html">
                                    <a href="javascript:void(0)" class="nav-link">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>接口权限管理</p>
                                    </a>
                                </li>
                                <li class="nav-item menu-item" attr="./module/permission/menu.html">
                                    <a href="javascript:void(0)" class="nav-link">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>菜单管理</p>
                                    </a>
                                </li>
                                <li class="nav-item menu-item" attr="./module/permission/role.html">
                                    <a href="javascript:void(0)" class="nav-link">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>角色管理</p>
                                    </a>
                                </li>
                                <li class="nav-item menu-item" attr="./module/permission/rolePermissionAssign.html">
                                    <a href="javascript:void(0)" class="nav-link">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>接口权限分配</p>
                                    </a>
                                </li>
                                <li class="nav-item menu-item" attr="./module/permission/adminRoleAssign.html">
                                    <a href="javascript:void(0)" class="nav-link">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>角色分配</p>
                                    </a>
                                </li>
                                <li class="nav-item menu-item" attr="./module/permission/adminMenuAssign.html">
                                    <a href="javascript:void(0)" class="nav-link">
                                        <i class="far fa-circle nav-icon"></i>
                                        <p>菜单分配</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                -->
                </nav>
                <!-- ul end -->
            </div>

        </aside>
        <!-- aside end -->

        <div class="content-wrapper" id="pjax-container" style="background-color: #F2F2F2;">
        </div>


        <!-- content-wrapper end -->
        <footer class="main-footer">
            <strong>
                Copyright
                <a href="javascript:void(0)">HyperflyAdmin</a>
                .All rights reserved.
            </strong>
            <div class="float-right d-none d-sm-inline-block">
                <b>Version</b>
                1.0
            </div>
        </footer>
        <!-- footer end -->
    </div>
    <!-- wrapper -->

    <!-- update modal start -->
    <div class="modal fade" id="update-password-modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">更新密码</h5>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>新密码</label>
                        <input type="password" class="form-control" id="unique-update-admin-password">
                    </div>
                    <div class="form-group">
                        <label>再次确认</label>
                        <input type="password" class="form-control" id="unique-update-admin-repeat-password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="submit-update-admin-password-btn">保存</button>
                    <button type="button" class="btn btn-secondary" id="close-update-admin-password-modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <!-- update modal end -->
</div>
<script type="text/javascript">
    jq(document).ready(function () {

        //更新密码 start
        var updateAdminPasswordAjax = function (data) {
            var url = getRequestUrl('/Admin/v1/Admin/updateAdminPasswordByAccessToken')
            openLoad()
            ajaxPost(url, data, function (response) {
                closeLoad()
                if (isResponseSuccess(getResponseCode(response))) {
                    layerSuccess(getResponseMessage(response), function () {
                        layerWarning('请重新登录', function () {
                            return redirectToLogin()
                        })
                    })
                }
                handleUnSuccess()
            })
        }
        jq('#submit-update-admin-password-btn').on('click', function () {
            var password = jq('#unique-update-admin-password').val()
            var repeatPassword = jq('#unique-update-admin-repeat-password').val()
            if (password.length === 0) {
                return layerWarning('请填写密码')
            }
            if (password.length < 6 || password.length > 16) {
                return layerWarning('密码长度必须是6-16个字符')
            }
            var reg = /^[0-9a-zA-Z]*$/
            if (!reg.test(password)) {
                return layerWarning('密码只能是数字字母')
            }
            if (repeatPassword.length === 0) {
                return layerWarning('请再次输入密码')
            }
            if (password !== repeatPassword) {
                return layerWarning('两次密码不一致')
            }
            var data = {}
            data.password = password
            updateAdminPasswordAjax(data)
        })
        //更新密码 end

        //打开修改密码modal start
        jq('#update-admin-password-btn').on('click', function () {
            jq('#update-password-modal').modal({
                backdrop: 'static',
                keyboard: false,
            })
            jq('#update-password-modal').modal('show')
        })
        //打开修改密码modal end

        //关闭修改密码modal start
        jq('#close-update-admin-password-modal').on('click', function () {
            jq('#update-password-modal').modal('hide')
        })
        //关闭修改密码modal end

        //获取管理员数据 start
        var getAdminAjax = function () {
            var url = getRequestUrl('/Admin/v1/Admin/getAdminByAccessToken')
            openLoad()
            ajaxPost(url, {}, function (response) {
                if (isResponseSuccess(getResponseCode(response))) {
                    var admin = getResponseData(response).admin
                    jq('#admin-username').text(admin.username)
                    jq('#admin-username').addClass('get-admin-success')
                    return
                }
                jq('#admin-username').text('未获取账号')
                handleUnSuccess()
            })
        }
        getAdminAjax()
        //获取管理员数据 end

        //生成树形菜单HTML start
        var createMenuHtml = function (menuTree, parentId) {
            for (menu in menuTree) {
                if (menuTree[menu].children.length > 0) {
                    var liItem = '<li class="nav-item li-toggle-ul">'
                    liItem += '<a class="nav-link toggle-ul" href="javascript:void(0)">'
                    liItem += '<i class="nav-icon fas fa-list-ul"></i>'
                    liItem += '<p>' + menuTree[menu].name
                    liItem += '<i class="right fas fa-plus-circle"></i>'
                    liItem += '</p>'
                    liItem += '</a>'

                    liItem += '</li>'
                    var li = jq(liItem)
                    var childMenuUl = '<ul class="nav nav-treeview" style="display: none">'
                    childMenuUl += '</ul>'
                    jq(li).append(childMenuUl).appendTo(parentId)
                    createMenuHtml(menuTree[menu].children, jq(li).children().eq(1))
                } else {
                    var childMenuLi = '<li class="nav-item menu-item" attr="' + menuTree[menu].href + '">'
                    childMenuLi += '<a class="nav-link" href="javascript:void(0)">'
                    childMenuLi += '<i class="nav-icon far fa-circle"></i>'
                    childMenuLi += '<p>' + menuTree[menu].name + '</p>'
                    childMenuLi += '</a>'
                    childMenuLi += '</li>'
                    jq(childMenuLi).appendTo(parentId)
                }
            }
        }
        //生成树形菜单HTML end

        //遍历出树形菜单json数据 start
        var getTreeMenu = function (menu, parentId = 0) {
            var tree = []
            jq(menu).each(function () {
                if (this.parent_id === parentId) {
                    var tmp = {}
                    tmp.menu_id = this.menu_id
                    tmp.name = this.get_menu.name
                    tmp.href = this.get_menu.href
                    tmp.children = getTreeMenu(menu, this.menu_id)
                    tree.push(tmp)
                }
            })
            return tree
        }
        //遍历出树形菜单json数据 start

        //获取菜单 end
        var getMenuUrl = getRequestUrl('/Admin/v1/Admin/getMenu')
        ajaxPost(getMenuUrl, {}, function (response) {
            if (isResponseSuccess(getResponseCode(response))) {
                var menu = getResponseData(response).result
                var tree = getTreeMenu(menu)
                var ulWrapper = '<ul class="nav nav-pills nav-sidebar flex-column menu-ul"></ul>'
                var domHtml = jq(ulWrapper)
                createMenuHtml(tree, domHtml)
                jq('#menu-container').append(domHtml)
            }
            handleUnSuccess(response)
        })
        //获取菜单 end

        //打开/关闭菜单 start
        jq('#menu-container').on('click', 'a.toggle-ul', function () {
            //切换父级菜单右侧icon样式
            jq(this).find('p').children().toggleClass('fa-minus fa-plus-circle')
            //切换父级菜单颜色样式
            jq(this).toggleClass('bg-primary')
            //打开菜单动画效果
            jq(this).next('ul').toggle('fast', 'swing')
            //jq(this).children('ul').show()
            //标示当前打开的菜单
            /*
            jq(this).next('ul').children('li.menu-item').each(function () {
                jq(this).find('i').toggleClass('fa-circle fa-dot-circle')
            })
            jq(this).parent().parent('ul').children('li.menu-item').each(function () {
                jq(this).find('i').toggleClass('fa-dot-circle fa-circle')
            })

             */

        })
        //打开/关闭菜单 end

        //动态加载pjax数据 start
        jq('#menu-container').on('click', 'li.menu-item', function () {
            var url = jq(this).attr('attr')
            if (url.length === 0) {
                return layerWarning('未指定`href`地址')
            }
            jq('li.menu-item').each(function () {
                jq(this).children().removeClass('active')
            })
            jq(this).children().addClass('active')
            jq.pjax({
                url: url,
                container: '#pjax-container',
                push: false,
                fragment: '#pjax-content'
            })
        })
        //动态加载pjax数据 end

        //退出 start
        jq("#sign-out").on("click", function () {
            var url = getRequestUrl('/Admin/v1/Admin/logout')
            var data = {'adminAccessToken': getAdminAccessTokenCache()}
            openLoad()
            ajaxPost(url, data, function (response) {
                closeLoad()
                if (isResponseSuccess(getResponseCode(response))) {
                    layerSuccess(getResponseMessage(response), function () {
                        deleteAdminAccessTokenCache()
                        redirectToLogin()
                    })
                }
                handleUnSuccess(response)
            })
        })
        //退出 end
    })
    //jq.ready end

    //进入首页默认加载的数据 start
    jq.pjax({
        url: './module/permission/admin.html',
        container: '#pjax-container',
        push: false,
        fragment: '#pjax-content'
    })
    //进入首页默认加载的数据 end

    var pjaxLoadIndex
    jq(document).on('pjax:send', function () {
        pjaxLoadIndex = layer.load(2)
    })

    jq(document).on('pjax:complete', function () {
        layer.close(pjaxLoadIndex)
    })
    jq(document).on('pjax:timeout', function (event) {
        event.preventDefault()
    })
    jq(document).on('pjax:error', function (event, xhr, textStatus, errorThrown, options) {
        options.success(xhr.responseText, textStatus, xhr);
        return false;
    });
</script>

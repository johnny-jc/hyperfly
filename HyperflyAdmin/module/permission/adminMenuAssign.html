<link rel="stylesheet" href="../../static/plugins/layui/css/layui.css">
<link rel="stylesheet" href="../../static/plugins/layui_ext/dtree/dtree.css">
<link rel="stylesheet" href="../../static/plugins/layui_ext/dtree/font/dtreefont.css">

<link rel="stylesheet" href="../../static/plugins/AdminLTE-3.1.0/dist/css/adminlte.css">
<link rel="stylesheet" href="../../static/plugins/select2/css/select2.css">
<div id="pjax-content">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">菜单分配管理</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="javascript:void(0)">首页</a></li>
                        <li class="breadcrumb-item active">菜单分配管理</li>
                    </ol>
                </div>
            </div>
        </div>
        <!-- container-fluid -->

        <!-- content-header -->
        <div class="content">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-inline">
                                        <div class="form-group mx-sm-3 mb-2" style="width:250px;">
                                            <select class="form-control" id="select-assign-admin"
                                                    style="width:100%;">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <!--
                                    <button type="button" id="refresh-btn"
                                            class="btn btn-primary btn-sm mx-sm-2 float-right">
                                        <span class="fa fa-sync-alt"></span>
                                        刷新
                                    </button>
                                    -->
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="dataTables_wrapper dt-bootstrap4"></div>
                            <div class="row">
                                <div class="col-12">
                                    <!--
                                    <label>
                                        <div class="checkbox">
                                            <label style="cursor:pointer;">
                                                <input type="checkbox" class="iCheck" id="admin-menu-icheck-all">
                                                <span>全选/反选</span>
                                            </label>
                                        </div>
                                    </label>
                                    -->
                                    <label>
                                        <button id="assign-admin-menu-btn" type="button"
                                                class="btn btn-primary btn-sm">保存
                                        </button>
                                    </label>
                                </div>
                            </div>
                            <div class="row border">
                                <div class="col-12">
                                    <div class="row">
                                        <div class="col-12" style="height: 500px;overflow: scroll">
                                            <div class="form-group" id="admin-menu-list">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- row end -->
                        </div>
                        <!--card body end -->
                    </div>
                    <!-- card end -->
                </div>
            </div>
        </div>
    </div>
    <!-- content -->
    <script src="../../static/plugins/jquery-pagination/pagination.js"></script>
    <script src="../../static/plugins/select2/js/select2.min.js"></script>
    <script src="../../static/plugins/jquery-icheck/icheck.js"></script>
    <!--<script src="../../static/plugins/layui/layui.all.js"></script>-->
    <script type="text/javascript">
        jq(document).ready(function () {

            //分配菜单 start
            var assignAdminMenu = function (data) {
                var url = getRequestUrl('/Admin/v1/AdminMenu/assignAdminMenu')
                openLoad()
                ajaxPost(url, data, function (response) {
                    closeLoad()
                    if (isResponseSuccess(getResponseCode(response))) {
                        layerSuccess(getResponseMessage(response), function () {
                            var adminId = jq('#select-assign-admin').val()
                            if (adminId === null) {
                                layerWarning('请选择管理员')
                                return
                            }
                            getTreeMenu({adminId: adminId})
                        })
                    }
                    handleUnSuccess(response)
                })
            }
            //分配菜单 end

            //获取树形菜单 start
            var getTreeMenu = function (data) {
                var url = getRequestUrl('/Admin/v1/AdminMenu/getAdminMenuByAdminId')
                openLoad()
                ajaxPost(url, data, function (response) {
                        closeLoad()
                        if (isResponseSuccess(getResponseCode(response))) {
                            var data = getResponseData(response)
                            var result = data.result
                            layui.use('dtree', function () {
                                var dtree = layui.dtree
                                dtree.render({
                                    elem: '#admin-menu-list',
                                    checkbar: true,
                                    checkbarType: "all",
                                    checkbarData: 'all',
                                    skin: "zdy",
                                    data: result,
                                })
                            })
                        }
                        handleUnSuccess(response)
                    }
                )
                /*
                var getCheckedMenuUnique = function (checkedMenu, allMenu = []) {
                    jq(checkedMenu).each(function () {
                        var id = this.id
                        var path = this.path
                        var level = this.level
                        var unique = String(id) + '|' + path + '|' + String(level)
                        allMenu.push(unique)
                        var children = this.children
                        getCheckedMenuUnique(children, allMenu)
                    })
                    return allMenu
                }
                */
            }
            //获取树形菜单 end

            //保存 start
            jq('#assign-admin-menu-btn').on('click', function () {
                var adminId = jq('#select-assign-admin').val()
                if (adminId === null || adminId.length === 0) {
                    return layerWarning('请选择管理员')
                }
                layui.use('dtree', function () {
                    var dtree = layui.dtree
                    var checkedMenu = dtree.getCheckbarNodesParam('admin-menu-list')
                    var checkedMenuArr = []
                    jq(checkedMenu).each(function () {
                        if (this.checked == '1') {
                            var menuId = this.nodeId
                            var path = this.basicData.path
                            var level = this.basicData.level
                            var sort = this.basicData.sort
                            var parentId = this.parentId
                            var menuStr = String(menuId) + '|' + path + '|' + String(level) +
                                '|' + String(parentId) + '|' + String(sort)
                            checkedMenuArr.push(menuStr)
                        }
                    })
                    var checkedMenuStr = JSON.stringify(checkedMenuArr)
                    var data = {adminId: adminId, menuStr: checkedMenuStr}
                    assignAdminMenu(data)
                })
            })
            //保存 end

            //获取所有管理员 start
            jq('#select-assign-admin').on('change', function () {
                var adminId = jq(this).val()
                if (adminId === null) {
                    layerWarning('请选择要分配的管理员')
                    return
                }
                getTreeMenu({adminId: adminId})
            })
            //获取所有管理员 end

            //icheck start
            jq('.iCheck').iCheck({
                checkboxClass: 'icheckbox_minimal-blue',
            })
            //icheck end

            //select2 start
            jq('#select-assign-admin').select2({
                allowClear: true,
                placeholder: "请选择要分配菜单的管理员",
                value: "id",
                name: "name",
                ajax: {
                    url: getRequestUrl('/Admin/v1/Admin/getAdminList'),
                    dataType: 'json',
                    type: 'POST',
                    headers: {'Authentication': getAdminAccessTokenCache()},
                    delay: 250,
                    cache: true,
                    data: function (params) {
                        return {
                            username: params.term,
                            offset: (params.page - 1) * 3 || 0,
                            limit: 3,
                        }
                    },
                    processResults: function (res, params) {
                        if (isResponseSuccess(getResponseCode(res))) {

                            params.page = params.page || 1
                            var listData = res.data
                            if (Object.keys(listData).length === 0) {
                                return
                            }
                            var adminList = listData.list
                            var optionList = []
                            var optionsStr = ''
                            for (var i = 0; i < adminList.length; i++) {
                                optionsStr = {"id": adminList[i].id, "text": adminList[i].username}
                                optionList.push(optionsStr)
                            }
                            return {
                                results: optionList,
                                pagination: {
                                    more: params.page < listData.count
                                }
                            }
                        }
                        handleUnSuccess(res)
                    },
                }
            })
            //select2 end

        })
    </script>
</div>

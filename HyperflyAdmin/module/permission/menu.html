<link rel="stylesheet" href="../../static/plugins/select2/css/select2.css">
<link rel="stylesheet" href="../../static/plugins/jquery-pagination/pagination.css">
<link rel="stylesheet" href="../../static/plugins/jquery-icheck/skins/all.css">

<div id="pjax-content">
    <input type="hidden" id="table-data-type" value="reset">
    <input type="hidden" id="refresh-child-menu-id" value="0">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">菜单管理</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="javascript:void(0)">首页</a></li>
                        <li class="breadcrumb-item active">菜单管理</li>
                    </ol>
                </div>
            </div>
        </div>
        <!-- container-fluid -->

        <!-- content-header -->
        <div class="content">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-sm-9">
                                    <div class="form-inline">
                                        <div class="form-group mx-sm-3 mb-2">
                                            <input type="text" id="search-menu-id" class="form-control"
                                                   placeholder="ID">

                                            <input type="text" id="search-menu-name" class="form-control"
                                                   placeholder="搜索所有菜单名称">
                                        </div>
                                        <button id="search-btn" class="btn btn-primary mb-2">搜索</button>
                                        <button id="reset-search-btn" class="btn btn-primary mb-2 mx-sm-2">所有顶级菜单
                                        </button>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <button type="button" id="create-menu-btn"
                                            class="btn btn-primary btn-sm float-right">
                                        添加菜单
                                    </button>
                                    <button type="button" id="refresh-btn"
                                            class="btn btn-primary btn-sm float-right mx-sm-2">
                                        <span class="fa fa-sync-alt"></span>
                                        刷新
                                    </button>

                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="dataTables_wrapper dt-bootstrap4"></div>
                            <div class="row">
                                <div class="col-12">
                                    <table class="table table-bordered table-hover dataTable dtr-inline" role="grid">
                                        <thead>
                                        <tr role="row">
                                            <th>ID</th>
                                            <th>名称</th>
                                            <th>添加时间</th>
                                            <th>更新时间</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody id="table-data">
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-12 col-md-5">
                                    <div class="dataTables_info" id="example2_info" role="status" aria-live="polite">
                                        总共&nbsp;<b><span id="total-count">/</span></b>&nbsp;条&nbsp;<b><span
                                            id="total-page">/
                                    </span></b>
                                        &nbsp;页数据，当前显示第<b>&nbsp;<span id="total-cur-page">/</span> &nbsp;</b>页数据
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-7">
                                    <div class="dataTables_paginate float-right">
                                        <div id="pagination"></div>
                                    </div>
                                    <!-- pagination end -->
                                </div>
                            </div>
                            <!-- row end -->
                        </div>
                        <!--card body end -->
                    </div>
                    <!-- card end -->
                </div>
            </div>
        </div>
    </div>
    <!-- content -->

    <!-- update modal start -->
    <div class="modal" id="edit-menu-modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑菜单</h5>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-menu-id" value="">
                    <div class="form-group">
                        <label>菜单名称</label>
                        <input type="text" class="form-control" id="edit-menu-name">
                    </div>
                    <div class="form-group">
                        <label>菜单地址</label>
                        <input type="text" class="form-control" id="edit-menu-href">
                    </div>

                    <div class="form-group">
                        <label>排序</label>
                        <input type="text" class="form-control" id="edit-menu-sort">
                    </div>
                    <!--
                    <div class="form-group">
                        <label>父级菜单</label>
                        <select class="form-control" id="edit-select-parent-menu" style="width:100%;">
                        </select>
                    </div>
                    -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="submit-edit-menu-btn">保存</button>
                    <button type="button" class="btn btn-secondary close-modal" attrId="edit-menu-modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <!-- update modal end -->

    <!-- child menu modal start -->
    <div class="modal" id="delete-child-menu-modal">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="h5">查看子菜单
                        <!--<button class="btn btn-warning btn-sm">批量删除</button>-->
                    </span>
                    <span>
                    <button class="btn btn-default btn-sm close-modal float-right" attrId="delete-child-menu-modal">关闭
                    </button>
                    <button class="btn btn-primary btn-sm float-right mx-sm-2" id="refresh-child-table-data-btn">
                        <span class="fa fa-sync-alt"></span>
                        刷新
                    </button>
                    </span>

                </div>
                <div class="modal-body">
                    <table class="table table-bordered table-hover dataTable dtr-inline" role="grid">
                        <thead>
                        <tr role="row">
                            <!--
                            <th>
                                <input type="checkbox" class="minimal input-checkbox input-checkbox-master"
                                       name="child-select-all"
                                       id="child-select-all">
                                ID
                            </th>
                            -->
                            <th>名称</th>
                            <th>添加时间</th>
                            <th>更新时间</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="child-table-data">
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>
    <!-- child menu modal end -->

    <!-- create modal start -->
    <div class="modal fade" id="create-menu-modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加菜单</h5>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>菜单名称</label>
                        <input type="text" class="form-control" id="menu-name">
                    </div>
                    <div class="form-group">
                        <label>菜单地址</label>
                        <input type="text" class="form-control" id="menu-href">
                    </div>

                    <div class="form-group">
                        <label>排序</label>
                        <input type="text" class="form-control" id="menu-sort">
                    </div>
                    <div class="form-group">
                        <label>父级菜单</label>
                        <select class="form-control" id="select-parent-menu" style="width:100%;">
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="submit-create-menu-btn">添加</button>
                    <button type="button" class="btn btn-secondary" id="close-create-menu-modal-btn">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <!-- create modal end -->
    <script type="text/javascript" src="../../static/plugins/select2/js/select2.min.js"></script>
    <script type="text/javascript" src="../../static/plugins/jquery-pagination/pagination.js"></script>
    <script type="text/javascript" src="../../static/plugins/jquery-icheck/icheck.js"></script>
    <script type="text/javascript">
        jq(document).ready(function () {

            //刷新子菜单table data start
            jq('#refresh-child-table-data-btn').on('click', function () {
                var menuId = jq('#refresh-child-menu-id').val()
                if (menuId == '0') {
                    return
                }
                getChildMenuList(menuId)
            })
            //刷新子菜单table data end

            //刷新table data start
            jq('#refresh-btn').on('click', function () {
                var type = jq('#table-data-type').val()
                tableDataPagination(type)
            })
            //刷新table data end

            //点击保存编辑 start
            jq('#submit-edit-menu-btn').on('click', function () {
                var id = jq('#edit-menu-id').val()
                var name = jq('#edit-menu-name').val()
                var sort = jq('#edit-menu-sort').val()
                var href = jq('#edit-menu-href').val()
                //var parentId = jq('#edit-select-parent-menu').val()
                var data = {id: id, name: name, sort: sort, href: href}
                updateMenuAjax(data)
            })
            //点击保存编辑 end

            //更新菜单 start
            var updateMenuAjax = function (data) {
                var url = getRequestUrl('/Admin/v1/Menu/updateMenuById')
                var type = jq('#table-data-type').val()
                openLoad()
                ajaxPost(url, data, function (response) {
                    closeLoad()
                    if (isResponseSuccess(getResponseCode(response))) {
                        layerSuccess(getResponseMessage(response), function () {
                            jq('#edit-menu-modal').modal('hide')
                            tableDataPagination(type)
                        })
                    }
                    handleUnSuccess(response)
                })
            }
            //更新菜单 end

            //打开编辑modal start
            jq('#table-data,#child-table-data').on('click', '.edit-menu-btn', function () {
                var menuId = jq(this).parents('tr').attr('attrId')
                getMenuDetail(menuId)
                jq('#edit-menu-modal').modal({
                    backdrop: 'static',
                    keyboard: false,
                })
                jq('#edit-menu-modal').modal({
                    backdrop: 'static',
                    keyboard: false,
                })
                jq('#edit-menu-modal').modal('show')
            })
            //打开编辑modal end

            //获取菜单详情 start
            var getMenuDetail = function (menuId) {
                var url = getRequestUrl('/Admin/v1/Menu/getMenuDetailById')
                openLoad()
                ajaxPost(url, {menuId: menuId}, function (response) {
                    closeLoad()
                    if (isResponseSuccess(getResponseCode(response))) {
                        jq('#edit-menu-name').val(response.data.menu.name)
                        jq('#edit-menu-sort').val(response.data.menu.sort)
                        jq('#edit-menu-id').val(response.data.menu.id)
                        jq('#edit-menu-href').val(response.data.menu.href)
                        /*
                        var parentId = response.data.parentMenu.id
                        var parentName = response.data.parentMenu.name
                        jq('#edit-select-parent-menu').select2({
                            allowClear: true,
                            placeholder: "请选择[默认为父级菜单]",
                            value: "id",
                            name: "name",
                            ajax: {
                                url: getRequestUrl('/Admin/v1/Menu/searchParentMenu'),
                                dataType: 'json',
                                type: 'POST',
                                headers: {'Authentication': getAdminAccessTokenCache()},
                                delay: 250,
                                cache: true,
                                data: function (params) {
                                    return {
                                        name: params.term,
                                        offset: (params.page - 1) * 3 || 0,
                                        limit: 3,
                                    }
                                },
                                processResults: function (res, params) {
                                    if (isResponseUnauthorized(getResponseCode(res))) {
                                        return layerWarning(getResponseMessage(res), function () {
                                            redirectToLogin()
                                        })
                                    }
                                    if (isResponseFail(getResponseCode(res))) {
                                        return layerFail(getResponseMessage(res))
                                    }
                                    params.page = params.page || 1
                                    var listData = res.data
                                    if (Object.keys(listData).length === 0) {
                                        return
                                    }
                                    var parentMenus = listData.parentMenus
                                    var optionList = []
                                    var optionsStr = ''
                                    for (var i = 0; i < parentMenus.length; i++) {
                                        optionsStr = {"id": parentMenus[i].id, "text": parentMenus[i].name}
                                        optionList.push(optionsStr)
                                    }
                                    return {
                                        results: optionList,
                                        pagination: {
                                            more: params.page < listData.count
                                        }
                                    }
                                },
                            }
                        })
                        //设置默认值 start
                        var option = new Option(parentName, parentId, true, true)
                        jq('#edit-select-parent-menu').append(option)
                        jq('#edit-select-parent-menu').trigger('change')
                        //设置默认值 end
                        */
                    }
                    handleUnSuccess(response)
                })
            }
            //获取菜单详情 end

            //关闭modal start
            jq('.close-modal').on('click', function () {
                var id = jq(this).attr('attrId')
                jq('#' + id).modal('hide')
            })
            //关闭modal end

            //删除子级菜单全选/反选 start
            jq('#delete-child-menu-modal').on('ifClicked', 'input.input-checkbox-master', function (event) {
                if (event.target.checked) {
                    jq('input.child-input-checkbox').iCheck('uncheck')
                } else {
                    jq('input.child-input-checkbox').iCheck('check')
                }
            })
            //删除子级菜单全选/反选 end

            //获取分页列表 start
            var url = getRequestUrl('/Admin/v1/Menu/getMenuList')
            var tableDataPagination = function (type) {
                //设置type值，刷新数据需要获取
                jq('#table-data-type').val(type)
                jq('#pagination').pagination({
                    pageRange: 2,
                    className: 'paginationjs-theme-blue paginationjs-big',
                    pageSize: 20,
                    showFirstOnEllipsisShow: true,
                    showLastOnEllipsisShow: true,
                    callback: function (data, pagination) {
                        var count = pagination.totalNumber
                        var pageNumber = pagination.pageNumber
                        var pageSize = pagination.pageSize
                        var offset = (pageNumber - 1) * pageSize
                        var limit = pageSize

                        //设置统计数据 start
                        jq('#total-count').text(count)
                        jq('#total-page').text(Math.ceil(count / pageSize))
                        jq('#total-cur-page').text(pageNumber)
                        //设置统计数据 end

                        var name = jq('#search-menu-name').val()
                        var id = jq('#search-menu-id').val()
                        var data = {}
                        data.name = name
                        data.id = id
                        data.offset = offset
                        data.limit = limit
                        data.type = type

                        openLoad()
                        ajaxPost(url, data, function (response) {
                            closeLoad()
                            if (isResponseSuccess(getResponseCode(response))) {
                                var listHtml = ''
                                var listDataObj = response.data.list
                                var listDataObjLen = Object.keys(listDataObj).length
                                for (var i = 0; i < listDataObjLen; i++) {
                                    listHtml += '<tr attrId="' + listDataObj[i].id + '">'
                                    listHtml += '<td style="width:5%">'
                                    listHtml += listDataObj[i].id
                                    listHtml += '</td>'
                                    listHtml += '<td style="width:15%">' + listDataObj[i].name + '</td>'
                                    listHtml += '<td style="width:30%">' + listDataObj[i].create_time + '</td>'
                                    listHtml += '<td style="width:30%">' + listDataObj[i].update_time + '</td>'
                                    listHtml += '<td>'
                                    //删除 start
                                    listHtml +=
                                        '<a class="btn btn-primary btn-xs delete-menu-btn" title="删除" href="javascript:void(0)">'
                                    listHtml += '<span class="fa fa-trash">'
                                    listHtml += '</span>'
                                    listHtml += '</a>'
                                    //删除 end
                                    //编辑 start
                                    listHtml +=
                                        '<a href="javascript:void(0)" class="btn btn-primary btn-xs mx-sm-2 edit-menu-btn">'
                                    listHtml += '<span class="fa fa-edit">'
                                    listHtml += '</span>'
                                    listHtml += '</a>'
                                    //编辑 end
                                    //查看子菜单 start
                                    listHtml +=
                                        '<a class="btn btn-primary btn-xs view-child-menu" title="查看子菜单" href="javascript:void(0)">'
                                    listHtml += '<span class="fa fa-eye">'
                                    listHtml += '</span>'
                                    listHtml += '</a>'
                                    //查看子菜单 start
                                    listHtml += '</td>'
                                    listHtml += '</tr>'
                                }
                                jq('#table-data').html(listHtml)

                            }
                            handleUnSuccess(response)
                        })
                    },

                    dataSource: function (done) {
                        var name = jq('#search-menu-name').val()
                        var id = jq('#search-menu-id').val()
                        var data = {}
                        data.name = name
                        data.id = id
                        data.type = type
                        openLoad()
                        ajaxPost(url, data, function (response) {
                            closeLoad()
                            var listArr = []
                            if (isResponseSuccess(getResponseCode(response))) {
                                for (var i = 0; i < response.data.count; i++) {
                                    listArr.push(i)
                                }
                                done(listArr)
                            }
                            handleUnSuccess(response)
                        })
                    },
                })
            }
            tableDataPagination('reset')
            //获取分页列表 end

            //点击重置按钮 start
            jq('#reset-search-btn').on('click', function () {
                jq('#search-menu-name').val('')
                jq('#search-menu-id').val('')
                tableDataPagination('reset')
            })
            //点击重置按钮 end

            //点击搜索按钮 start
            jq('#search-btn').on('click', function () {
                tableDataPagination('search')
            })
            //点击搜索按钮 end

            //删除菜单 start
            var deleteMenuById = function (menuId, type, parentId = null) {
                var url = getRequestUrl('/Admin/v1/Menu/deleteMenuById')
                layer.confirm('确定删除?[删除父级菜单请先删除子菜单]', {
                    btn: ['确定', '取消'],
                }, function () {
                    openLoad()
                    ajaxPost(url, {id: menuId}, function (response) {
                        closeLoad()
                        if (isResponseSuccess(getResponseCode(response))) {
                            layerSuccess(getResponseMessage(response), function () {
                                if (type === 'parent') {
                                    tableDataPagination('reset')
                                }
                                if (type === 'child') {
                                    getChildMenuList(parentId)
                                }
                            })
                        }
                        handleUnSuccess(response)
                    })
                })
            }
            jq('#table-data').on('click', '.delete-menu-btn', function () {
                var menuId = jq(this).parents('tr').attr('attrId')
                deleteMenuById(menuId, 'parent')
            })
            jq('#child-table-data').on('click', '.delete-menu-btn', function () {
                var menuId = jq(this).parents('tr').attr('attrId')
                var parentMenuId = jq(this).parents('tr').attr('attrParentId')
                deleteMenuById(menuId, 'child', parentMenuId)
            })
            //删除菜单 end

            //查看子菜单 start
            var getChildMenuList = function (menuId) {
                jq('#refresh-child-menu-id').val(menuId)
                var url = getRequestUrl('/Admin/v1/Menu/getChildMenuList')
                openLoad()
                ajaxPost(url, {parentId: menuId}, function (response) {
                    closeLoad()
                    if (isResponseSuccess(getResponseCode(response))) {
                        var listDataObj = response.data
                        var listDataObjLen = Object.keys(listDataObj).length
                        var htmlStr = ''
                        if (listDataObjLen === 0) {
                            htmlStr = '<p class="h6">没有查询到任何数据...</p>'
                        } else {
                            listDataObj = listDataObj.result
                            listDataObjLen = Object.keys(listDataObj).length
                            for (var i = 0; i < listDataObjLen; i++) {
                                htmlStr += '<tr attrParentId="' + menuId + '" attrId="' + listDataObj[i].id + '">'
                                /*
                                htmlStr += '<td>'
                                htmlStr +=
                                    '<input type="checkbox" class="minimal input-checkbox child-input-checkbox">'
                                htmlStr += listDataObj[i].id
                                htmlStr += '</td>'
                                */
                                htmlStr += '<td style="width:15%">' + listDataObj[i].name + '</td>'
                                htmlStr += '<td style="width:30%">' + listDataObj[i].create_time + '</td>'
                                htmlStr += '<td style="width:30%">' + listDataObj[i].update_time + '</td>'
                                htmlStr += '<td>'
                                htmlStr +=
                                    '<a class="btn btn-primary btn-xs delete-menu-btn" href="javascript:void(0)" title="删除">'
                                htmlStr += '<span class="fa fa-trash"></span>'
                                htmlStr += '</a>'
                                htmlStr +=
                                    '<a class="btn btn-primary btn-xs edit-menu-btn mx-sm-2" href="javascript:void(0)" title="编辑">'
                                htmlStr += '<span class="fa fa-edit"></span>'
                                htmlStr += '</a>'
                                htmlStr +=
                                    '<a class="btn btn-primary btn-xs view-child-menu" href="javascript:void(0)" title="查看子菜单">'
                                htmlStr += '<span class="fa fa-eye"></span>'
                                htmlStr += '</a>'
                                htmlStr += '</td>'
                                htmlStr += '</tr>'
                            }
                        }
                        jq('#child-table-data').html(htmlStr)
                        jq('input.input-checkbox').iCheck({
                            checkboxClass: 'icheckbox_minimal-blue'
                        })
                        jq('#delete-child-menu-modal').modal({
                            backdrop: 'static',
                            keyboard: false,
                        })
                        jq('#delete-child-menu-modal').modal('show')
                    }
                    handleUnSuccess(response)
                })
            }
            jq('#table-data,#child-table-data').on('click', '.view-child-menu', function () {
                var menuId = jq(this).parents('tr').attr('attrId')
                getChildMenuList(menuId)
            })
            //查看子菜单 end

            //select2 start
            jq('#select-parent-menu').select2({
                allowClear: true,
                placeholder: "请选择[默认为父级菜单]",
                value: "id",
                name: "name",
                ajax: {
                    url: getRequestUrl('/Admin/v1/Menu/searchParentMenu'),
                    dataType: 'json',
                    type: 'POST',
                    headers: {'Authentication': getAdminAccessTokenCache()},
                    delay: 250,
                    cache: true,
                    data: function (params) {
                        return {
                            name: params.term,
                            offset: (params.page - 1) * 3 || 0,
                            limit: 3,
                        }
                    },
                    processResults: function (res, params) {
                        if (isResponseSuccess(getResponseCode(res))) {

                            params.page = params.page || 1
                            var listData = res.data
                            if (Object.keys(listData).length === 0) {
                                return
                            }
                            var parentMenus = listData.parentMenus
                            var optionList = []
                            var optionsStr = ''
                            for (var i = 0; i < parentMenus.length; i++) {
                                optionsStr = {
                                    "id": parentMenus[i].id, "text": String(parentMenus[i].id) +
                                        '-' + parentMenus[i].name
                                }
                                optionList.push(optionsStr)
                            }
                            return {
                                results: optionList,
                                pagination: {
                                    more: params.page < listData.count
                                }
                            }
                        }
                        handleUnSuccess(res)
                    },
                }
            })
            //select2 end

            //打开添加菜单modal start
            jq('#create-menu-btn').on('click', function () {
                jq('#create-menu-modal').modal({
                    backdrop: 'static',
                    keyboard: false,
                })
                jq('#create-menu-modal').modal('show')
            })
            jq('#close-create-menu-modal-btn').on('click', function () {
                jq('#create-menu-modal').modal('hide')
            })
            //关闭添加菜单modal end

            //添加菜单modal start
            jq('#submit-create-menu-btn').on('click', function () {
                var name = jq('#menu-name').val()
                var sort = jq('#menu-sort').val()
                var href = jq('#menu-href').val()
                var parentMenuId = jq('#select-parent-menu option:selected').val()
                if (name === '') {
                    return layerWarning('请填写名称')
                }
                var initReg = /^[\d]+$/;
                if (sort !== '' && !initReg.test(sort)) {
                    return layerWarning('排序值只能是数字')
                }
                jq('#menu-name').val("")
                jq('#menu-sort').val("")
                jq('#menu-href').val("")
                var url = getRequestUrl('/Admin/v1/Menu/createMenu')
                var data = {name: name, sort: sort, parentMenuId: parentMenuId, href: href}
                openLoad()
                ajaxPost(url, data, function (response) {
                    closeLoad()
                    if (isResponseSuccess(getResponseCode(response))) {
                        layerSuccess(getResponseMessage(response), function () {
                            jq('#create-menu-modal').modal('hide')
                            jq('#select-parent-menu').empty()
                            var type = jq('#table-data-type').val()
                            tableDataPagination(type)
                        })
                    }
                    handleUnSuccess(response, function () {
                        jq('#menu-name').val(name)
                        jq('#menu-sort').val(sort)
                        jq('#menu-href').val(href)
                    })
                })
            })
            //添加菜单modal end

            //设置关闭modal后下拉框重置 start
            $('body').on('hidden.bs.modal', '.modal', function () {
                jq('#select-parent-menu').empty()
            });
            //设置关闭modal后下拉框重置 end

            //设置最新打开的modal显示在最高层级 start
            jq('body').on('show.bs.modal', '.modal', function () {
                var zIndex = 1040 + (10 * $('.modal:visible').length);
                $(this).css('z-index', zIndex);
                setTimeout(function () {
                    $('.modal-backdrop').not('.modal-stack').css('z-index', zIndex - 1).addClass('modal-stack');
                }, 0);
            })
            //设置最新打开的modal显示在最高层级 start

            //修复多层顶层modal 关闭后底层modal高度无法滚动 start
            jq(document).on('hidden.bs.modal', '.modal', function () {
                jq('.modal:visible').length && $(document.body).addClass('modal-open');
            })
            //修复多层顶层modal 关闭后底层modal高度无法滚动 end
        })
    </script>
</div>
<link rel="stylesheet" href="../../static/plugins/jquery-pagination/pagination.css">

<div id="pjax-content">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">权限管理</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="javascript:void(0)">首页</a></li>
                        <li class="breadcrumb-item active">权限管理</li>
                    </ol>
                </div>
            </div>
        </div>
        <!-- container-fluid -->

        <!-- content-header -->
        <div class="content">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-sm-9">
                                    <div class="form-inline">
                                        <div class="form-group mx-sm-3 mb-2">
                                            <input type="text" id="search-api-app" class="form-control"
                                                   placeholder="接口应用[默认Admin]">
                                            <input type="text" id="search-api-version" class="form-control"
                                                   placeholder="接口版本[默认v1]">
                                            <input type="text" id="search-api-class" class="form-control"
                                                   placeholder="接口类">
                                            <input type="text" id="search-api-function" class="form-control"
                                                   placeholder="接口函数">
                                        </div>
                                        <button id="search-btn" class="btn btn-primary mb-2">搜索</button>
                                        <button id="reset-search-btn" class="btn btn-primary mb-2 mx-sm-2">重置
                                        </button>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <button type="button" id="generate-permission-btn"
                                            class="btn btn-primary btn-sm float-right">
                                        生成所有权限
                                    </button>
                                    <button type="button" id="refresh-btn"
                                            class="btn btn-primary btn-sm float-right mx-sm-2">
                                        <span class="fa fa-sync-alt"></span>
                                        刷新
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="dataTables_wrapper dt-bootstrap4"></div>
                            <div class="row">
                                <div class="col-12">
                                    <table class="table table-bordered table-hover dataTable dtr-inline" role="grid">
                                        <thead>
                                        <tr role="row">
                                            <th>接口路由</th>
                                            <th>接口应用</th>
                                            <th>接口版本</th>
                                            <th>接口类</th>
                                            <th>接口函数</th>
                                        </tr>
                                        </thead>
                                        <tbody id="table-data">
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-12 col-md-5">
                                    <div class="dataTables_info" id="example2_info" role="status" aria-live="polite">
                                        总共&nbsp;<b><span id="total-count">/</span></b>&nbsp;条&nbsp;<b><span
                                            id="total-page">/
                                    </span></b>
                                        &nbsp;页数据，当前显示第<b>&nbsp;<span id="total-cur-page">/</span> &nbsp;</b>页数据
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-7">
                                    <div class="dataTables_paginate float-right">
                                        <div id="pagination"></div>
                                    </div>
                                    <!-- pagination end -->
                                    <!-- pagination end -->
                                </div>
                            </div>
                            <!-- row end -->
                        </div>
                        <!--card body end -->
                    </div>
                    <!-- card end -->
                </div>
            </div>
        </div>
    </div>
    <!-- content -->
    <script type="text/javascript" src="../../static/plugins/jquery-pagination/pagination.js"></script>
    <script type="text/javascript">
        jq(document).ready(function () {

            //reset search btn start
            jq('#reset-search-btn').on('click', function () {
                jq('#search-api-app').val('')
                jq('#search-api-version').val('')
                jq('#search-api-class').val('')
                jq('#search-api-function').val('')
                tableDataPagination()
            })
            //reset search btn end

            //search btn start
            jq('#search-btn,#refresh-btn').on('click', function () {
                tableDataPagination()
            })
            //search btn end

            //generate permission btn start
            jq('#generate-permission-btn').on('click', function () {
                var url = getRequestUrl('/Admin/v1/Permission/generateFilePermissions')
                openLoad()
                ajaxPost(url, {}, function (response) {
                    closeLoad()
                    if (isResponseSuccess(getResponseCode(response))) {
                        layerSuccess(getResponseMessage(response), function () {
                            tableDataPagination()
                        })
                    }
                    handleUnSuccess(response)
                })
            })

            //generate permission btn end

            //获取分页 start
            var tableDataPagination = function () {
                var url = getRequestUrl('/Admin/v1/Permission/getPermissionList')
                jq('#pagination').pagination({
                    pageRange: 2,
                    className: 'paginationjs-theme-blue paginationjs-big',
                    pageSize: 20,
                    showFirstOnEllipsisShow: true,
                    showLastOnEllipsisShow: true,
                    callback: function (data, pagination) {

                        var count = pagination.totalNumber
                        var pageNumber = pagination.pageNumber
                        var pageSize = pagination.pageSize
                        var offset = (pageNumber - 1) * pageSize
                        var limit = pageSize

                        //设置统计数据 start
                        jq('#total-count').text(count)
                        jq('#total-page').text(Math.ceil(count / pageSize))
                        jq('#total-cur-page').text(pageNumber)
                        //设置统计数据 end

                        var data = {}

                        var apiApp = jq('#search-api-app').val()
                        var apiVersion = jq('#search-api-version').val()
                        var apiClass = jq('#search-api-class').val()
                        var apiFunction = jq('#search-api-function').val()

                        data.apiApp = apiApp
                        data.apiVersion = apiVersion
                        data.apiClass = apiClass
                        data.apiFunction = apiFunction
                        data.offset = offset
                        data.limit = limit

                        openLoad()
                        ajaxPost(url, data, function (response) {
                            closeLoad()
                            if (isResponseSuccess(getResponseCode(response))) {
                                var data = getResponseData(response)
                                var listHtml = ''
                                var listDataObj = data.list
                                var listDataObjLen = Object.keys(listDataObj).length
                                for (var i = 0; i < listDataObjLen; i++) {
                                    listHtml += '<tr>'
                                    listHtml += '<td style="width:30%">'
                                    listHtml += listDataObj[i].api_route
                                    listHtml += '</td>'
                                    listHtml += '<td style="width:15%">'
                                    listHtml += listDataObj[i].api_app
                                    listHtml += '</td>'
                                    listHtml += '<td style="width:15%">'
                                    listHtml += listDataObj[i].api_version
                                    listHtml += '</td>'
                                    listHtml += '<td style="width:15%">'
                                    listHtml += listDataObj[i].api_class
                                    listHtml += '</td>'
                                    listHtml += '<td style="width:25%">'
                                    listHtml += listDataObj[i].api_function
                                    listHtml += '</td>'
                                    listHtml += '<tr>'
                                }
                                jq('#table-data').html(listHtml)
                            }
                            handleUnSuccess(response)
                        })
                    },

                    dataSource: function (done) {
                        var data = {}

                        var apiApp = jq('#search-api-app').val()
                        var apiVersion = jq('#search-api-version').val()
                        var apiClass = jq('#search-api-class').val()
                        var apiFunction = jq('#search-api-function').val()

                        data.apiApp = apiApp
                        data.apiVersion = apiVersion
                        data.apiClass = apiClass
                        data.apiFunction = apiFunction

                        openLoad()
                        ajaxPost(url, data, function (response) {
                            closeLoad()
                            var listArr = []
                            if (isResponseSuccess(getResponseCode(response))) {
                                var data = getResponseData(response)
                                for (var i = 0; i < data.count; i++) {
                                    listArr.push(i)
                                }
                                done(listArr)
                            }
                            handleUnSuccess(response)
                        })
                    },
                })
            }
            tableDataPagination()
            //获取分页 end
        })
    </script>
</div>

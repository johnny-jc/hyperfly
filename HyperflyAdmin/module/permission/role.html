<link rel="stylesheet" href="../../static/plugins/jquery-pagination/pagination.css">
<link rel="stylesheet" href="../../static/plugins/jquery-icheck/skins/all.css">
<!-- create admin modal start -->
<div class="modal fade" id="create-role-modal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加角色</h5>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>名称</label>
                    <input type="text" class="form-control" id="create-role-name">
                </div>
                <div class="form-group">
                    <label>状态</label>
                    <input type="radio" name="create-role-status" checked value="1">正常
                    <input type="radio" name="create-role-status" value="0">禁用
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="submit-create-role-btn">添加</button>
                <button type="button" class="btn btn-secondary" id="close-create-modal-btn">关闭</button>
            </div>
        </div>
    </div>
</div>
<!-- create admin modal end -->

<div id="pjax-content">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">角色管理</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="javascript:void(0)">首页</a></li>
                        <li class="breadcrumb-item active">角色管理</li>
                    </ol>
                </div>
            </div>
        </div>
        <!-- container-fluid -->

        <!-- content-header -->
        <div class="content">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-sm-9">
                                    <div class="form-inline">
                                        <div class="form-group mx-sm-3 mb-2">
                                            <input type="text" id="search-role-name" class="form-control"
                                                   placeholder="名称">
                                        </div>
                                        <button id="search-btn" class="btn btn-primary mb-2">搜索</button>
                                        <button id="reset-search-btn" class="btn btn-primary mb-2 mx-sm-2">重置
                                        </button>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <button type="button" id="create-role-btn"
                                            class="btn btn-primary btn-sm float-right">
                                        添加角色
                                    </button>
                                    <button type="button" id="refresh-btn"
                                            class="btn btn-primary btn-sm float-right mx-sm-2">
                                        <span class="fa fa-sync-alt"></span>
                                        刷新
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="dataTables_wrapper dt-bootstrap4"></div>
                            <div class="row">
                                <div class="col-12">
                                    <table class="table table-bordered table-hover dataTable dtr-inline" role="grid">
                                        <thead>
                                        <tr role="row">
                                            <th>ID</th>
                                            <th>名称</th>
                                            <th>添加时间</th>
                                            <th>状态</th>
                                            <th>更新时间</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody id="table-data">
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-12 col-md-5">
                                    <div class="dataTables_info" id="example2_info" role="status" aria-live="polite">
                                        总共&nbsp;<b><span id="total-count">/</span></b>&nbsp;条&nbsp;<b><span
                                            id="total-page">/
                                    </span></b>
                                        &nbsp;页数据，当前显示第<b>&nbsp;<span id="total-cur-page">/</span> &nbsp;</b>页数据
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-7">
                                    <div class="dataTables_paginate float-right">
                                        <div id="pagination"></div>
                                    </div>
                                    <!-- pagination end -->
                                </div>
                            </div>
                            <!-- row end -->
                        </div>
                        <!--card body end -->
                    </div>
                    <!-- card end -->
                </div>
            </div>
        </div>
    </div>
    <!-- update modal start -->
    <div class="modal" id="update-role-modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑角色</h5>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="update-role-id" value="">
                    <div class="form-group">
                        <label>角色名称</label>
                        <input type="text" class="form-control" id="update-role-name">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="submit-update-role-btn">保存</button>
                    <button type="button" class="btn btn-secondary close-modal" id="close-update-role-modal-btn">关闭
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- edit modal end -->
    <!-- content -->
    <script type="text/javascript" src="../../static/plugins/jquery-pagination/pagination.js"></script>
    <script type="text/javascript" src="../../static/plugins/jquery-icheck/icheck.js"></script>
    <script type="text/javascript">
        jq(document).ready(function () {

            //删除角色 start
            var deleteRoleAjax = function (roleId) {
                var url = getRequestUrl('/Admin/v1/Role/deleteRoleById')
                openLoad()
                ajaxPost(url, {id: roleId}, function (response) {
                    closeLoad()
                    if (isResponseSuccess(getResponseCode(response))) {
                        layerSuccess(getResponseMessage(response), function () {
                            tableDataPagination()
                        })
                    }
                    handleUnSuccess(response)
                })
            }
            jq('#table-data').on('click', '.delete-role-btn', function () {
                var roleId = jq(this).parents('tr').attr('attrId')
                if (roleId === '' || roleId.length === 0) {
                    return layerWarning('获取不到角色ID')
                }
                layer.confirm('确定删除？[删除角色将一并删除角色关联的管理员以及接口权限]', {
                    btn: ['确定', '取消'],
                }, function () {
                    deleteRoleAjax(roleId)
                })
            })
            //删除角色 end

            //保存编辑 start
            var updateRoleAjax = function (data) {
                var url = getRequestUrl('/Admin/v1/Role/updateRoleById')
                openLoad()
                ajaxPost(url, data, function (response) {
                    closeLoad()
                    if (isResponseSuccess(getResponseCode(response))) {
                        layerSuccess(getResponseMessage(response), function () {
                            jq('#update-role-modal').hide()
                            tableDataPagination()
                        })
                    }
                    handleUnSuccess(response)
                })
            }
            jq('#submit-update-role-btn').on('click', function () {
                var roleId = jq('#update-role-id').val()
                var roleName = jq('#update-role-name').val()
                if (roleId === '' || roleId.length === 0) {
                    return layerWarning('获取不到角色ID')
                }
                if (roleName.length === 0) {
                    return layerWarning('请填写角色名称')
                }
                updateRoleAjax({'id': roleId, 'name': roleName})
            })
            //保存编辑 end

            //编辑角色 start
            jq('#table-data').on('click', '.update-role-btn', function () {
                var name = jq(this).parents('tr').children().eq(1).text()
                var roleId = jq(this).parents('tr').attr('attrId')
                jq('#update-role-id').val(roleId)
                jq('#update-role-name').val(name)
                jq('#update-role-modal').modal({
                    backdrop: 'static',
                    keyboard: false,
                })
                jq('#update-role-modal').show()
            })
            //编辑角色 end

            //关闭编辑角色 start
            jq('#close-update-role-modal-btn').on('click', function () {
                jq('#update-role-modal').hide()
            })
            //关闭编辑角色 end

            //更新角色状态 start
            var updateRoleStatus = function (roleId, status) {
                var url = getRequestUrl('/Admin/v1/Role/updateRoleStatusById')
                var data = {}
                data.id = roleId
                data.status = status
                openLoad()
                ajaxPost(url, data, function (response) {
                    closeLoad()
                    if (isResponseSuccess(getResponseCode(response))) {
                        layerSuccess(getResponseMessage(response), function () {
                            tableDataPagination()
                        })
                    }
                    handleUnSuccess(response)
                })
            }
            jq('#table-data').on('ifClicked', '.list-role-status', function (event) {
                var roleId = jq(this).parents('tr').attr('attrId')
                var value = event.target.value
                updateRoleStatus(roleId, value)
            })
            //更新角色状态 end

            //搜索 start
            jq('#search-btn,#refresh-btn').on('click', function () {
                tableDataPagination()
            })
            //搜索 end

            //重置 start
            jq('#reset-search-btn').on('click', function () {
                jq('#search-role-name').val('')
                tableDataPagination()
            })
            //重置 end

            //添加角色 start
            jq('#submit-create-role-btn').on('click', function () {
                var name = jq('#create-role-name').val()
                var status = jq('input[name="create-role-status"]:checked').val()
                if (name.length <= 0) {
                    return layerWarning('请填写名称')
                }
                if (name.length > 10) {
                    return layerWarning('名称最多只能10位字符')
                }
                if (status !== '0' && status !== '1') {
                    return layerWarning('状态值只能是正常或者禁用')
                }
                var data = {}
                data.name = name
                data.status = status
                var url = getRequestUrl('/Admin/v1/Role/createRole')
                openLoad()
                ajaxPost(url, data, function (response) {
                    closeLoad()
                    if (isResponseSuccess(getResponseCode(response))) {
                        layerSuccess(getResponseMessage(response), function () {
                            jq('#create-role-modal').modal('hide')
                            tableDataPagination()
                        })
                    }
                    handleUnSuccess(response)
                })
            })
            //添加角色 end

            //打开添加角色 start
            jq('#create-role-btn').on('click', function () {
                jq('#create-role-modal').modal({
                    backdrop: 'static',
                    keyboard: false,
                })
                jq('#create-role-modal').modal('show')
            })
            jq('#close-create-modal-btn').on('click', function () {
                jq('#create-role-modal').modal('hide')
            })
            //打开添加角色 end

            //create-role icheck start
            jq('input[name="create-role-status"]').iCheck({
                radioClass: 'iradio_square-blue'
            })
            //create-role icheck end

            //获取分页 start
            var tableDataPagination = function () {
                var url = getRequestUrl('/Admin/v1/Role/getRoleList')
                jq('#pagination').pagination({
                    pageRange: 2,
                    className: 'paginationjs-theme-blue paginationjs-big',
                    pageSize: 20,
                    showFirstOnEllipsisShow: true,
                    showLastOnEllipsisShow: true,
                    callback: function (data, pagination) {
                        var count = pagination.totalNumber
                        var pageNumber = pagination.pageNumber
                        var pageSize = pagination.pageSize
                        var offset = (pageNumber - 1) * pageSize
                        var limit = pageSize

                        //设置统计数据 start
                        jq('#total-count').text(count)
                        jq('#total-page').text(Math.ceil(count / pageSize))
                        jq('#total-cur-page').text(pageNumber)
                        //设置统计数据 end

                        var name = jq('#search-role-name').val()
                        var data = {}
                        data.name = name
                        data.offset = offset
                        data.limit = limit

                        openLoad()
                        ajaxPost(url, data, function (response) {
                            closeLoad()
                            if (isResponseSuccess(getResponseCode(response))) {
                                var data = getResponseData(response)
                                var listHtml = ''
                                var listDataObj = data.list
                                var listDataObjLen = Object.keys(listDataObj).length
                                for (var i = 0; i < listDataObjLen; i++) {
                                    var iRadioStr = ''
                                    if (listDataObj[i].status == 0) {
                                        iRadioStr +=
                                            '<input value="1" class="list-role-status" type="radio" name="list-role-status' + listDataObj[i].id + '">'
                                        iRadioStr += '<label class="text-primary">正常</label>'
                                        iRadioStr +=
                                            '<input value="0" class="list-role-status" checked type="radio" name="list-role-status' + listDataObj[i].id + '">'
                                        iRadioStr += '<label class="text-gray">禁用</label>'
                                    } else {
                                        iRadioStr +=
                                            '<input value="1" class="list-role-status" checked type="radio" name="list-role-status' + listDataObj[i].id + '">'
                                        iRadioStr += '<label class="text-primary">正常</label>'
                                        iRadioStr +=
                                            '<input value="0" class="list-role-status" type="radio" name="list-role-status' + listDataObj[i].id + '">'
                                        iRadioStr += '<label class="text-gray">禁用</label>'
                                    }
                                    listHtml += '<tr attrId="' + listDataObj[i].id + '">'
                                    listHtml += '<td>'
                                    listHtml += listDataObj[i].id
                                    listHtml += '</td>'
                                    listHtml += '<td>'
                                    listHtml += listDataObj[i].name
                                    listHtml += '</td>'
                                    listHtml += '<td>'
                                    listHtml += listDataObj[i].create_time
                                    listHtml += '</td>'
                                    listHtml += '<td>'
                                    listHtml += iRadioStr
                                    listHtml += '</td>'
                                    listHtml += '<td>'
                                    listHtml += listDataObj[i].update_time
                                    listHtml += '</td>'
                                    listHtml += '<td>'
                                    listHtml +=
                                        '<a class="btn btn-primary btn-xs delete-role-btn" href="javascript:void(0)" title="删除">'
                                    listHtml += '<span class="fa fa-trash"></span>'
                                    listHtml += '</a>'
                                    listHtml +=
                                        '<a class="btn btn-primary btn-xs update-role-btn mx-sm-2" href="javascript:void(0)" title="编辑">'
                                    listHtml += '<span class="fa fa-edit"></span>'
                                    listHtml += '</a>'

                                    listHtml += '</td>'
                                    listHtml += '</tr>'
                                }
                                jq('#table-data').html(listHtml)
                                jq('.list-role-status').iCheck({
                                    radioClass: 'iradio_square-blue'
                                })
                            }
                            handleUnSuccess(response)
                        })
                    },

                    dataSource: function (done) {
                        var name = jq('#search-role-name').val()
                        var data = {}
                        data.name = name
                        openLoad()
                        ajaxPost(url, data, function (response) {
                            closeLoad()
                            var listArr = []
                            if (isResponseSuccess(getResponseCode(response))) {
                                var data = getResponseData(response)
                                for (var i = 0; i < data.count; i++) {
                                    listArr.push(i)
                                }
                                done(listArr)
                            }
                            handleUnSuccess(response)
                        })
                    },
                })
            }
            tableDataPagination()
            //获取分页 end
        })
    </script>
</div>
